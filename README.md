# 纯粹的抽卡决斗

## 🎯 设计目标

打造一款节奏紧凑的双人抽卡对决游戏，核心体验围绕「随机抽牌 + 分数博弈 + 小规模运营」，同时通过层级推进、旅行商人和收藏要素制造出连续的惊喜感与逆转空间。

## 🧱 游戏结构概要

| 层级 | 关键事件 | 玩家初始状态 | 特殊规则 |
| --- | --- | --- | --- |
| 第 1 层 | Entrance | $score=1$，无加成 | 标准卡池 |
| 第 2 层 | Deepening | 保留上一层滞留卡 | 开放部分进阶卡 |
| 第 2.5 层 | Traveling Merchant A | 旅行商人事件 | 可购入 1 张额外卡牌加入滞留位或背包 |
| 第 3 层 | Pivot | 背包卡可自由使用 | 引入反制性卡牌 |
| 第 4 层 | Pressure | 引入高倍率卡 | 增加副作用概率 |
| 第 4.5 层 | Traveling Merchant B | 旅行商人事件 | 商人卡可跨层携带 |
| 第 5 层 | Verdict | 最终对决 | 存在更多胜利碎片 |

胜负条件：五局三胜；任一玩家收集 3 枚「胜利碎片」立即绝杀。

## 🗂️ 源码目录规划

```text
src/
  game/
    types.ts          // 核心类型定义与常量
    cards.ts          // 卡牌原型与实例化工厂
    levels.ts         // 层级配置、卡池构建逻辑
    engine.ts         // 回合/结算/胜利判定的纯函数

  components/
    CardDisplay.tsx   // 卡牌及提示的展示组件
    PlayerHUD.tsx     // 玩家得分、滞留位、碎片信息
    MerchantModal.tsx // 旅行商人事件界面
    TurnLog.tsx       // 关键事件日志 & 提示

  App.tsx             // 顶层 UI，协调状态机
  App.css             // 页面排版与主题
```

## 🔄 游戏核心流程

1. **层级初始化**：
   - 双方 $score=1$，保留滞留位与背包。
   - 根据 `levels.ts` 构建并洗牌当层卡堆，生成公开信息（稀有度、胜利碎片分布）。

2. **玩家阶段**：
   - 每位玩家基础可抽 3 张，最多 5 张；额外抽卡权由卡牌效果累积。
   - 每次抽牌后可 **立即结算**、**放入滞留位**（仅 1 格）或 **丢弃**。
   - 滞留位卡牌可在任意时机释放，连续释放会形成 combo。

3. **AI/对手阶段**：
   - 简易策略：优先保留高倍率卡于滞留位；若分数低于对手显著落后，则冒险抽到 5 次。
   - AI 也会使用胜利碎片与层通行证。

4. **结算阶段**：
   - 应用层通行证（`max(score, 50)` 等）等延迟效果。
   - 比较双方分数，记录胜负局数。
   - 检查是否触发旅行商人或比赛胜利。

5. **旅行商人阶段**（2.5 / 4.5）：
   - 提供 3 张随机精选卡（来源于下一层卡池加特殊事件卡）。
   - 玩家仅能购入 1 张，消耗当层积分赎买值（默认 10 分或一张持有卡）。
   - 购入卡可选择放入滞留位或背包（下一层开始才能使用）。

## 🃏 卡牌体系

| 分类 | 代表卡 | 效果 | 备注 |
| --- | --- | --- | --- |
| 运算卡 | 连锁加法、暴击倍增 | `add`, `multiply` | 决定主要分数走势 |
| 风险卡 | 归零试胆、负向迁移 | `reset`, `steal` | 造成高风险高收益 |
| 资源卡 | 时间扭曲、抽牌加速 | `extraDraw`, `duplicate` | 建立节奏优势 |
| 胜利碎片 | 「命运碎片」 | `victoryShard` | 收集 3 枚瞬杀 |
| 通行证 | “x层通行证” | `levelPass` | 结算时保底 50 分，可跨层携带 |
| 商人限定 | 秘密交换、护甲护盾 | `shield`, `swap` | 仅旅行商人提供 |

详细原型见 `cards.ts`，每张卡都会在实例化时生成随机数值（例如 $\pm2\sim\pm8$ 的加减幅度），并以稀有度控制出现概率。

## ⚙️ 状态机设计

- `GameState.phase`: `'playerTurn' | 'aiTurn' | 'levelEnd' | 'merchant' | 'matchEnd'`
- `GameState.level`: 1-5，半层用 `merchant` phase 标识。
- `PlayerState`：维护 `score`、`drawsUsed`、`extraDraws`、`holdCard`、`backpack`、`victoryShards`、`wins`、`passTokens`。
- `DeckState`：`drawPile`、`discardPile`、`publicInfo`（剩余胜利碎片、稀有卡数量）。
- `LogEntry`：时间戳、事件类型、描述文本，用于 UI 日志回放。

所有数值运算通过 `engine.ts` 中的纯函数完成，React 组件只负责触发动作和展示结果。

## 🧠 主要交互逻辑

- **抽牌**：`engine.drawCard()` 返回新的 `GameState` + 抽到的 `CardInstance`。
- **使用卡牌**：`engine.resolveCard()` 根据 `CardEffect` 类型计算分数或状态。
- **滞留位释放**：`engine.releaseHold()`，支持多张连锁时的加成描述。
- **回合结束**：`engine.completeTurn()` 自动触发延迟效果、AI 行动和胜利判断。
- **旅行商人**：`engine.presentMerchant()` 生成报价列表，`engine.acceptOffer()` 更新玩家库存。

## 🛠️ 技术实现规划

1. **数据层**：先完成 `types.ts`、`cards.ts`、`levels.ts` 与 `engine.ts`，确保可通过单元测试验证核心逻辑。
2. **UI 层**：
   - 顶部：层级/胜场/碎片概览。
   - 中部：双方面板 + 日志。
   - 底部：操作面板（抽牌、使用、滞留位控制、结束回合）。
   - 弹窗：旅行商人与关键事件。
3. **AI 策略**：简单优先级 + 随机因素，逐步可调。
4. **测试**：计划加入 `vitest` 针对 `engine.ts` 的纯函数测试（后续迭代完成）。

## 🚀 开发里程碑

- [x] 设计文档与目录规划
- [ ] 核心引擎函数
- [ ] UI 组件与交互
- [ ] 旅行商人事件
- [ ] AI 策略调优
- [ ] 自动化测试覆盖

随后章节将由代码实现同步推进，本存储库 README 将在主要里程碑后更新。

## BUG反馈以及优化建议

### 第一期

1. 玩家操作引导有点弱, 用户不清楚当前可以操作什么, 请改为会有波纹的按钮(轻量动效), 以及鼠标悬浮时的气泡提示(antd组件), 如果回合中可以动的操作全部没有了, 对"结束回合"按钮进行高亮提示.
2. 事件日志有些单调了, 而且超过十位数之后, 十位数会被遮挡, 这个计数可以替换成secondary的颜色; 此外, 最新的日志出现的时候, 背景做一个灰色的闪烁, 然后保持淡灰色(表示这是最新的事件), 注意轻量化实现, 日志的高度做一个限制(只显示3行)
3. 日志中如果提到了卡牌, 应当给一个特别的圆角背景色块, 以及鼠标悬浮时的气泡提示(显示的是卡牌的详细信息)
4. 待处理的卡牌和滞留位改为卡牌位放在玩家操作的下面, 卡牌应当是竖着的矩形, 最左侧是牌叠(展示牌背), 右侧是刚抽到的牌, 再右侧有一个居中的竖着的虚线, 然后依次是滞留的牌(给两个槽位), 虚线框表示滞留位(比牌大一点点)
5. 抽牌给一个轻量的动画, 牌从上淡入抽牌位置, 存入滞留位时, 牌从抽牌位置移动到滞留位(自动判断空位), 如果使用(包括滞留位), 则向上淡出; 丢弃时, 牌向下淡出

### 第二期

1. **玩家操作按钮优化**
   - **引导动效**: 将当前可操作按钮的动效从“点击波纹”改为“持续脉冲/闪烁”，以主动提示玩家当前可执行的操作。
   - **悬浮效果**: 移除按钮在鼠标悬浮时的阴影效果，保持扁平化（Flat）设计风格。

2. **滞留位机制与交互调整**
   - **栈式结构**: 滞留位（Hold Slots）应调整为 LIFO（后进先出）的栈结构，允许两张牌。
   - **使用规则**: 玩家只能使用最新放入（最前端）的滞留卡。
   - **动画与状态**:
       *存入新卡时，所有已滞留的卡牌向后移动一个位置。
     - 使用滞留卡后，其后的卡牌向前递补。
   - **按钮逻辑**: “滞留”按钮仅在滞留区有空位时才可点击。

3. **卡牌展示与信息层级优化**
   - **牌面信息**: 将完整的卡牌效果描述直接展示在牌面上，而非仅在 Tooltip 中。效果描述区域应使用色块衬底以突出。若描述过长，则截断并在悬浮时通过 Tooltip 显示全文。
   - **操作按钮分离**: 移除卡牌上的“释放滞留卡”按钮，统一移至玩家主操作区。
   - **稀有度展示**:
       *在卡牌顶部增加一个与稀有度颜色对应的横条（如：灰色代表普通），取代居中文字。稀有度名称可作为小字印在横条上。
     - 卡牌名称使用带颜色的背景块和反色文字（如白字）进行高亮。
   - **信息字段**: 卡牌数据结构应区分 `description`（牌面完整描述）和 `keywords`（用于 Tooltip 中展示的额外补充词条）。
   - **Tooltip 样式**: 自定义 Tooltip 样式，改为白色背景、黑色文字，以提升可读性。

4. **旅行商人机制与视觉升级**
   - **视觉强化**:
     - 商人提供的“强化项”应有独特视觉，区别于普通卡牌（如使用深绿色底），并增加内衬线和随稀有度变化的边框花纹，提升品质感。
   - **代价机制**:
       *将购买方式从“消耗当层分数”改为“付出代价”。
     - 强化项的展示分为上下两部分：上半部分为“增益效果”，下半部分为“付出代价”。
     - 代价的类型和强度应与强化项的稀有度挂钩。例如，稀有度越高，效果越强，但代价也越大（如“下一轮少抽一张牌”、“起始分数降低”等）。每次商人事件随机生成增益与代价组合。

5. **事件日志功能完善**
   - **滚动与历史**: 日志区域高度固定为显示 3 条，但需保留全部历史日志。当新日志产生时，自动滚动到底部。增加滚动条，允许玩家向上翻阅历史记录。

### 第三期

1. 小BUG, 卡牌抽取次数用完之后, 抽卡按钮还是显示, 把这个按钮的抽卡两个字改成抽卡，方括号几杠几。这样子的话，用户一看就知道了。呃。然后如果说已经抽完所有次数了，那么这个按钮就应该变成不可点击的状态。然后呢，它这个动效有点不太明显。呃，你可以把这个动效改的频率高一点吗？稍微高一点。
2. 我调整了整个面板的结构，让所有的这个对手全部放在左上角然后一整个右边都是事件日志，呃。然后我对于玩家。和AI他们的这个，呃，人物的这个面板。应该是保持一致的然后呢？之前的呃，防御盾还有这个胜利碎片啊这种呢，都现在统一为一个概念，叫做buff，那么这个增益啊。呃，它是各种各样的效果的一种统称。呃，可以放在这个no buff这个区域，那么这个区域之后所有的buff都会显示成一个小方块，这个小方块上面有个简单的图标，然后呢，呃，鼠标点击，或者说是悬浮在这个图标上面。就会显示这个buff的具体的内容。嗯，这个buff呢，也分说是全局的，还有就是，呃，永远的持续的，还有一种是那个呃回合的，那么也就是有些是临时的增益，只在当前回合有效。那么像这种的话呢，它需要有一个角标来标识它是一个临时的，嗯，可以就是，嗯，它的右下角画一个三角。然后这个三角可以是一个特别的颜色，比如说是黄色，那么金色吧，那就右下角是一个金色的一个斜的三角形，那么这种就表示说他呃，下一个它是临时的一种buff。呃，然后这个buff会有很多。所以说你可以用一个呃，就是横向的一个滚动吧。然后，嗯。如果。如果说他有。啊，那然后它这个，它这个就是你悬浮上去的，就是我buff的一个提示，它应该是一个比较全面的，就他说的属性都要显示出来。那么因为引入了这个增益，所以说你之前的代码里面，比如说加盾啊，或者说加这个胜利碎片呢，他都应该去做成这个buff的形式。啊。然后。然后相同的buff应当是叠加在一块的。比如说就拿胜利碎片举例，这个胜利碎片它是一个全局的，它是一个所有时候都存在的，呃，一个buff，所以说它是没有角标的。其次，如果我一开始没有这个。胜利碎片，那么他就不显示，如果有了的话就显示，那么如果我有第二个的话，我要去检索当前有的这个增益，然后我发现说我已经有一个碎片了，那么他这个两个buff就应该叠加在一块儿，然后角标上写的是一个二，他表示我有两个生理碎片了。然后这个胜利碎片呢，他就你这个图标啊，就可以用一个拼图，对吧？呃，我会把所有的这个图标都放在assets/svg文件夹里面，然后你可以去调用它。

## COPILOT 开发记录与上下文（用于后续迭代）

```markdown
目的：记录最近迭代的核心改动，便于后续继续实现和排查。

### 第三期迭代 (2025-10-16)

1) 核心改动
- **抽卡按钮优化**：按钮文字显示为"抽卡 [已抽/总数]"，当抽完所有次数后按钮自动禁用。
- **动效频率提升**：将按钮脉冲动画频率从 2s 提高到 1.2s，增强视觉提示。
- **Buff 系统重构**：将原有的胜利碎片、防御盾、通行证等分散数据统一为 Buff 系统管理。

2) 新增/修改的文件
- `src/components/BuffDisplay.tsx` (新增)
  - 独立的 Buff 展示组件，支持图标、数量角标、临时 Buff 金色三角标识。
  - 鼠标悬浮显示 Buff 详细信息（名称、描述、效果类型、数值）。
  
- `src/components/BuffDisplay.css` (新增)
  - Buff 方块样式（48x48px）、临时 Buff 金色角标样式。
  - 横向滚动列表支持，带自定义滚动条样式。
  
- `src/components/PlayerHUD.tsx`
  - 重构为从 PlayerState 动态生成 Buff 列表。
  - 支持的 Buff 类型：胜利碎片、防御盾、额外抽卡（临时）、层通行证、商人代币、待处理惩罚（临时）。
  - 相同类型 Buff 自动合并并显示堆叠数量。
  
- `src/game/types.ts`
  - 扩展 `PlayerBuff` 接口：新增 `icon`（图标路径）、`isPermanent`（是否永久）、`count`（堆叠数量）字段。
  
- `src/game/engine.ts`
  - 在 `createInitialState` 中为 player 和 ai 初始化 `buffs: []` 字段。
  - 在 `clonePlayer` 中添加对 `buffs` 的深拷贝。
  
- `src/App.tsx`
  - 抽卡按钮文字改为动态显示：`抽卡 [${已抽}/${总数}]`。
  - 当抽完所有次数后，按钮自动禁用（通过 `drawsRemaining <= 0` 判断）。
  
- `src/App.css`
  - 调整 `.btn--glow` 动画周期从 2s 到 1.2s。
  - 增加 `@keyframes btn-glow` 的效果强度（box-shadow 从 6px/0.15 提升到 8px/0.25）。
  - 新增 `.player-hud__buffs` 样式区域，支持标题和横向滚动列表。

3) Buff 系统实现细节
- **图标路径**：使用 `/src/assets/svg/` 目录下的 SVG 图标（如拼图_puzzle.svg 表示胜利碎片）。
- **堆叠逻辑**：相同类型的 Buff（通过 `id` 区分）会合并为一个，右上角显示数量角标。
- **临时标识**：`isPermanent: false` 的 Buff 会在右下角显示金色三角标识，表示仅当前回合有效。
- **Tooltip 内容**：使用 Ant Design 的 Tooltip，自定义 `tooltip-light` 样式（白底黑字）。

4) 测试与验证
- `npm run build` ✅ 构建成功
- 动效频率提升明显可见
- Buff 显示区域支持横向滚动，超过区域后可滚动查看
- 临时 Buff 的金色三角角标正常显示

5) 建议的下一步
- 补充实际游戏逻辑中对 Buff 系统的应用（如结算时检查 Buff 效果）。
- 为 Buff 系统增加动画效果（获得/失去 Buff 时的淡入淡出）。
- 考虑添加 Buff 的排序逻辑（如按稀有度或临时/永久分组）。
- 完善 AI 的 Buff 使用策略。

---

### 第二期迭代

1) 高层概要
- 聚焦 UI 视觉统一：顶栏提示合并、卡牌牌面重绘、旅行商人报价体验强化。
- 维持第二期提出的交互规则（按钮脉冲、双槽滞留、日志 3 条窗口）。

2) 已修改 / 新增的文件
- src/App.tsx / src/App.css
  - 将全局提示行（卡堆剩余、阶段提示、胜利文案）内联到标题区，基于 Ant Design Space 布局。
  - 新增卡牌稀有度配色变量、固定牌面尺寸与装饰伪元素。
- src/components/CardDisplay.tsx
  - 重构卡牌结构：顶部稀有度色带 + 稀有度标签、圆角衬底卡名、主描述正文。
  - 去除默认 Card padding，接入稀有度主题颜色与修饰伪元素。
- src/components/MerchantModal.tsx / MerchantModal.less (若存在)
  - 增益/代价区域复用卡牌展示组件，上下分区，中线分隔并应用独立装饰风格。
- src/components/CardLane.tsx
  - 适配新的固定尺寸牌面，确保抽牌/滞留动画坐标一致。

3) 关键实现细节
- 稀有度主题通过 CSS 变量集中定义（normal/rare/epic/legend），同时驱动卡面底色、顶部色带、伪元素纹理。
- 使用 `.ant-card-body { padding: 0; }` 等定向覆写消除默认留白，使稀有度色带贴顶。
- 卡牌内容区采用 flex-column，描述正文有浅色衬底并支持 Tooltip 展示完整文本（逻辑沿用前一迭代）。
- 商人报价：增益与代价均为 CardDisplay 渲染，外层容器根据条目稀有度切换暗绿色底与边框花纹。

4) 运行与验证
- `npm run build` ✅
- 手动检查：顶栏提示与标题同行展示正确；不同稀有度卡牌视觉差异正常；商人商品上下结构与代价区使用同一组件、装饰独立。

5) 建议的下一步
- 将稀有度主题抽成独立样式模块，便于未来动态切换皮肤。
- 考虑为卡牌描述正文添加多语言 key，方便本地化。
- MerchantModal 可扩展动画或声音提示以强化购买决策反馈。

以上为历次迭代上下文，供后续开发参考。
```
